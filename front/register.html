<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro</title>

  <style>
    body{
      font-family:system-ui,Segoe UI,Roboto,Arial;
      margin:0;
      display:grid;
      place-items:center;
      min-height:100vh;
      background:#0b1020;
      color:#eaf0ff;
    }
    .card{
      background:#131a2a;
      width:min(520px,92vw);
      border-radius:16px;
      padding:22px;
      border:1px solid rgba(255,255,255,.08);
    }
    .row{ display:flex; flex-direction:column; gap:8px; margin:10px 0 }
    input,select{
      padding:12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:#0f1630;
      color:#eaf0ff;
    }
    button{
      padding:12px 16px;
      border-radius:10px;
      border:0;
      cursor:pointer;
      font-weight:600;
      background:#6ea8fe;
      color:#0b1020;
    }
    .error{ color:#ff6b6b; display:none; margin-top:6px }
    .ok{ color:#7ae582; display:none; margin-top:6px }
    a{ color:#6ea8fe }
  </style>

</head>
<body>
  <div class="card">
    <h2>Registro</h2>

    <form id="regForm">
      <div class="row">
        <label for="name">Nombre</label>
        <input id="name" required />
      </div>

      <div class="row">
        <label for="rut">RUT</label>
        <input id="rut" placeholder="12345678-9" required />
      </div>

      <div class="row">
        <label for="email">Correo</label>
        <input id="email" type="email" required />
      </div>

      <div class="row">
        <label for="password">Contraseña</label>
        <input id="password" type="password" required />
      </div>

      <div class="row">
        <label for="role">Rol</label>
        <select id="role" required>
          <option value="">Selecciona un rol</option>
          <option value="ADMIN">Administrador</option>
          <option value="E1">Estación 1 (E1)</option>
          <option value="E2">Estación 2 (E2)</option>
          <option value="E3">Estación 3 (E3)</option>
          <option value="E4">Estación 4 (E4)</option>
          <option value="E5">Estación 5 (E5)</option>
        </select>
      </div>

      <button type="submit">Crear cuenta</button>

      <div id="error" class="error"></div>
      <div id="ok" class="ok"></div>
    </form>

    <p style="margin-top:14px;"><a href="/login">Ir al Login</a></p>
  </div>

  <script>
    const API = "http://localhost:3000";
    const $ = s => document.querySelector(s);

    const form = $("#regForm"),
          name = $("#name"),
          rut = $("#rut"),
          email = $("#email"),
          password = $("#password"),
          role = $("#role"),
          errBox = $("#error"),
          okBox = $("#ok");

    function setError(msg){
      errBox.textContent = msg || "";
      errBox.style.display = msg ? "block" : "none";
      okBox.style.display = "none";
    }

    function setOk(msg){
      okBox.textContent = msg || "";
      okBox.style.display = msg ? "block" : "none";
      errBox.style.display = "none";
    }

    // ==========================
    // REGISTRO DE USUARIO
    // ==========================
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      setError("");
      setOk("");

      try{
        const res = await fetch(`${API}/register`, {
          method:"POST",
          headers: { "Content-Type":"application/json" },
          credentials:"include",
          body: JSON.stringify({
            name: name.value.trim(),
            rut: rut.value.trim(),
            email: email.value.trim(),
            password: password.value,
            role: role.value
          })
        });

        const data = await res.json();
        if(!res.ok || !data.ok)
          throw new Error(data?.message || "No se pudo registrar");

        setOk("Registro exitoso. Redirigiendo...");
        
        // limpiar inputs
        form.reset();

        // redirigir después de 1 segundo
        setTimeout(()=> location.href="/login", 900);

      }catch(err){
        setError(err.message);
      }
    });
  </script>
</body>
</html>